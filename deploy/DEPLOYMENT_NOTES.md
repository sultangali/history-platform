# History Platform - Deployment Guide

## Server Information

- **Server IP:** 34.51.218.216
- **Platform:** Google Cloud VPS (Ubuntu)
- **Repository:** git@github.com:sultangali/history-platform.git

## Quick Start

### 1. Copy deploy scripts to server

```bash
# From your local machine
scp -r deploy/* root@34.51.218.216:/root/deploy/
```

### 2. SSH into server

```bash
ssh root@34.51.218.216
```

### 3. Run full deployment

```bash
cd /root/deploy
chmod +x *.sh
./05-full-deploy.sh
```

## Deployment Scripts

| Script | Description |
|--------|-------------|
| `01-install-dependencies.sh` | Installs MongoDB, Node.js 20.x, PM2, Nginx, Certbot, Git |
| `02-deploy-app.sh` | Clones repo, installs dependencies, builds client, configures PM2 |
| `03-setup-nginx.sh` | Configures Nginx for HTTP access by IP |
| `04-setup-ssl.sh` | Sets up self-signed SSL certificate for IP |
| `05-full-deploy.sh` | Runs all scripts in sequence (interactive) |
| `06-update-domain.sh` | Adds domain name and Let's Encrypt SSL |

## Step-by-Step Deployment

### Step 1: Install Dependencies

```bash
sudo ./01-install-dependencies.sh
```

This installs:
- Node.js 20.x LTS
- MongoDB 7.0
- PM2 (process manager)
- Nginx (web server)
- Certbot (Let's Encrypt)
- Git, nano, htop, etc.

### Step 2: Deploy Application

```bash
sudo ./02-deploy-app.sh
```

**Important:** First run will generate SSH key. Add it to GitHub:
1. Copy the displayed public key
2. Go to GitHub → Repository → Settings → Deploy keys
3. Add new deploy key with read access

Then run the script again.

### Step 3: Configure Nginx

```bash
sudo ./03-setup-nginx.sh
```

Site will be available at: http://34.51.218.216

### Step 4: Setup SSL (Self-Signed)

```bash
sudo ./04-setup-ssl.sh
```

Site will be available at: https://34.51.218.216

**Note:** Self-signed certificates show browser warnings. For production, use Let's Encrypt with a domain.

### Step 5: Add Domain (When Ready)

```bash
sudo ./06-update-domain.sh
```

Before running:
1. Point your domain's A record to 34.51.218.216
2. Wait for DNS propagation (5-30 minutes)

## Directory Structure

```
/var/www/history-platform/       # Application source code
├── server/                      # Backend (Express.js)
│   ├── .env                     # Environment variables
│   └── ...
├── client/                      # Frontend (React/Vite)
│   ├── .env.production          # Production environment
│   └── ...
└── ecosystem.config.cjs         # PM2 configuration

/var/www/html/history-platform/  # Built frontend (served by Nginx)
```

## Environment Variables

### Server (.env)

```env
PORT=5000
NODE_ENV=production
MONGODB_URI=mongodb://127.0.0.1:27017/repression-archive
JWT_SECRET=<auto-generated>
JWT_EXPIRES_IN=7d
SERVER_IP=34.51.218.216
CORS_ORIGIN=https://34.51.218.216
```

### Client (.env.production)

```env
VITE_API_URL=https://34.51.218.216/api
```

## Common Commands

### PM2 (Process Manager)

```bash
pm2 status                       # Check status
pm2 logs history-platform-api    # View logs
pm2 restart all                  # Restart application
pm2 stop all                     # Stop application
pm2 delete all                   # Remove from PM2
```

### Nginx

```bash
sudo systemctl status nginx      # Check status
sudo systemctl reload nginx      # Reload configuration
sudo systemctl restart nginx     # Restart Nginx
sudo nginx -t                    # Test configuration
```

### MongoDB

```bash
sudo systemctl status mongod     # Check status
sudo systemctl restart mongod    # Restart MongoDB
mongosh                          # MongoDB shell
```

### Logs

```bash
# Nginx logs
tail -f /var/log/nginx/history-platform.access.log
tail -f /var/log/nginx/history-platform.error.log

# PM2 logs
pm2 logs history-platform-api

# MongoDB logs
sudo tail -f /var/log/mongodb/mongod.log
```

## Updating Application

```bash
cd /var/www/history-platform

# Pull latest changes
git pull origin main

# Rebuild client
cd client
npm install
npm run build
cp -r dist/* /var/www/html/history-platform/

# Update server
cd ../server
npm install

# Restart application
pm2 restart all
```

## Troubleshooting

### API not responding

1. Check PM2 status: `pm2 status`
2. Check logs: `pm2 logs history-platform-api`
3. Verify MongoDB: `sudo systemctl status mongod`
4. Test locally: `curl http://127.0.0.1:5000/api/health`

### 502 Bad Gateway

1. Application not running: `pm2 restart all`
2. Wrong port in Nginx config
3. Check Nginx error log

### SSL Certificate Issues

```bash
# Check certificate status
sudo certbot certificates

# Renew certificate
sudo certbot renew

# Test renewal
sudo certbot renew --dry-run
```

### Permission Issues

```bash
# Fix ownership
sudo chown -R www-data:www-data /var/www/html/history-platform
sudo chown -R root:root /var/www/history-platform
```

## Security Recommendations

1. **Change default MongoDB port** (optional)
2. **Enable MongoDB authentication** for production
3. **Setup fail2ban** for SSH protection
4. **Regular backups** of MongoDB data
5. **Keep system updated**: `sudo apt update && sudo apt upgrade`

## Backup MongoDB

```bash
# Create backup
mongodump --db repression-archive --out /backup/$(date +%Y%m%d)

# Restore backup
mongorestore --db repression-archive /backup/20241221/repression-archive
```

## Firewall Status

```bash
sudo ufw status

# Allowed ports:
# - 22 (SSH)
# - 80 (HTTP)
# - 443 (HTTPS)
```

## Contact

For issues with deployment, check the logs and verify each service is running correctly.

